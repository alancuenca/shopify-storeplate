---
import config from "@/config/config.json";
import theme from "@/config/theme.json";
import { plainify } from "@/lib/utils/textConverter";
import Footer from "@/partials/Footer.astro";
import Header from "@/partials/Header.astro";
import "@/styles/main.css";
import { AstroFont } from "astro-font";
import { ClientRouter } from "astro:transitions";
import Announcement from "./helpers/Announcement";

// Font configuration
const pf = theme.fonts.font_family.primary;
const sf = theme.fonts.font_family.secondary;

const fontPrimary = theme.fonts.font_family.primary
  ?.replace(/\+/g, " ")
  .replace(/:[ital,]*[ital@]*[wght@]*[0-9,;.]+/gi, "") || "Inter";

const fontSecondary = theme.fonts.font_family.secondary
  ?.replace(/\+/g, " ")
  .replace(/:[ital,]*[ital@]*[wght@]*[0-9,;.]+/gi, "") || "Inter";

// SEO Props interface
export interface Props {
  title?: string;
  meta_title?: string;
  description?: string;
  image?: string;
  noindex?: boolean;
  canonical?: string;
  type?: "website" | "product" | "article";
  // Product-specific SEO (JSON-LD)
  product?: {
    name: string;
    description: string;
    image: string;
    price: string;
    currency: string;
    availability: "InStock" | "OutOfStock" | "PreOrder";
    sku?: string;
    brand?: string;
  };
}

const {
  title,
  meta_title,
  description,
  image,
  noindex,
  canonical,
  type = "website",
  product
} = Astro.props;

const siteUrl = config.site.base_url;
const pageUrl = `${siteUrl}${Astro.url.pathname}`;
const pageTitle = plainify(meta_title || title || config.site.title);
const pageDescription = plainify(description || config.metadata.meta_description);
const pageImage = `${siteUrl}${image || config.metadata.meta_image}`;

// Generate JSON-LD structured data
const jsonLd = product ? {
  "@context": "https://schema.org",
  "@type": "Product",
  "name": product.name,
  "description": product.description,
  "image": product.image,
  "brand": product.brand ? { "@type": "Brand", "name": product.brand } : undefined,
  "sku": product.sku,
  "offers": {
    "@type": "Offer",
    "price": product.price,
    "priceCurrency": product.currency,
    "availability": `https://schema.org/${product.availability}`,
    "url": pageUrl
  }
} : {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": config.site.title,
  "url": siteUrl
};
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href={config.site.favicon} />
    <link rel="apple-touch-icon" href={config.site.favicon} />

    <!-- Primary Meta Tags -->
    <title>{pageTitle}</title>
    <meta name="title" content={pageTitle} />
    <meta name="description" content={pageDescription} />
    <meta name="author" content={config.metadata.meta_author} />
    <meta name="generator" content={Astro.generator} />

    <!-- Theme -->
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000" />

    <!-- Canonical -->
    {canonical ? (
      <link rel="canonical" href={canonical} />
    ) : (
      <link rel="canonical" href={pageUrl} />
    )}

    <!-- Robots -->
    {noindex ? (
      <meta name="robots" content="noindex, nofollow" />
    ) : (
      <meta name="robots" content="index, follow" />
    )}

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={type === "product" ? "product" : "website"} />
    <meta property="og:url" content={pageUrl} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:image" content={pageImage} />
    <meta property="og:site_name" content={config.site.title} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={pageUrl} />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={pageImage} />

    <!-- JSON-LD Structured Data -->
    <script is:inline type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

    <!-- Google Fonts -->
    <AstroFont
      config={[
        {
          src: [],
          preload: false,
          display: "swap",
          name: fontPrimary,
          fallback: "sans-serif",
          cssVariable: "font-primary",
          googleFontsURL: `https://fonts.googleapis.com/css2?family=${pf}&display=swap`,
        },
        {
          src: [],
          preload: false,
          display: "swap",
          name: fontSecondary,
          fallback: "sans-serif",
          cssVariable: "font-secondary",
          googleFontsURL: `https://fonts.googleapis.com/css2?family=${sf}&display=swap`,
        },
      ]}
    />

    <!-- View Transitions -->
    <ClientRouter />
  </head>

  <body class="min-h-screen flex flex-col">
    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-primary text-white px-4 py-2 rounded z-50">
      Skip to content
    </a>

    <Announcement client:load />
    <Header />

    <main id="main-content" class="grow">
      <slot />
    </main>

    <Footer />
  </body>
</html>
